<!DOCTYPE html>
<html>
<head>
    <title>动态请求不同Style的arcgis 动态图层</title>
    <link rel="stylesheet" href="../lib/ol.css" type="text/css">
    <script src="../lib/ol.js"></script>
    <script src="../lib/jquery-1.8.0.min.js"></script>
</head>
<body>
<div id="map" class="map"></div>
<script>
    var projection = ol.proj.get('EPSG:4326');
    var tileUrl = "http://211.101.37.251:6080/arcgis/rest/services/jxgxptmap_2015ncyw/MapServer";
    var dynamticLayerUrl = "http://171.34.40.68:6080/arcgis/rest/services/jiangxi/GL_GPSROAD";
    var tileArcGISXYZ;
    $.ajax({
        url: tileUrl + "?f=pjson",
        dataType: "json",
        success: function (data) {
            var resolutions = [];
            var origin = [data.tileInfo.origin.x, data.tileInfo.origin.y];
            var len = data.tileInfo.lods.length;
            var fullExtent = [data.fullExtent.xmin, data.fullExtent.ymin, data.fullExtent.xmax, data.fullExtent.ymax];
            for (var i = 0; i < len; i++) {
                resolutions.push(data.tileInfo.lods[i].resolution);
            }
            var tileGrid = new ol.tilegrid.TileGrid({
                tileSize: data.tileInfo.cols,
                origin: origin,
                extent: fullExtent,
                resolutions: resolutions
            });
            var urlTemplate = tileUrl + "/tile/{z}/{y}/{x}";
            tileArcGISXYZ = new ol.source.XYZ({
                tileGrid: tileGrid,
                projection: projection,
                tileUrlFunction: function (tileCoord) {
                    var url = urlTemplate.replace('{z}', (tileCoord[0]).toString())
                            .replace('{x}', tileCoord[1].toString())
                            .replace('{y}', (-tileCoord[2] - 1).toString());
                    return url;
                }
            });

            var map = new ol.Map({
                controls: [new ol.control.ScaleLine()],
                target: 'map',
//                layers: [
//                    new ol.layer.Tile({
//                        source: tileArcGISXYZ
//                    }),
//                    new ol.layer.Image({
//                        source: new ol.source.ImageStatic({
//                            url: 'http://localhost:63343/ol3-demos/img/6.png',
//                            projection: projection,
//                            imageExtent: [60.896230706385204, 0.9508582428290315, 157.40716910286136, 62.53130907371668]
//                        })
//                    })
//
//                ],
                view: new ol.View({
                    center    : [109.15169990462329, 31.74108365827285],
                    zoom      : 4,
                    projection: projection,
                    extent    : [4.96, 0.9508582428290315, 157.40716910286136, 62.53130907371668]
                })
            });

            var params = {
                layers: 'show:0',
                transparent:false,
                layerDefs: '0:1=1',
                dynamicLayers: '[{"id":0,"source":{"type":"mapLayer","mapLayerId":0},"drawingInfo":{"renderer":{"type":"simple","symbol":{"type":"esriSFS","style":"esriSFSSolid","color":[255,255,0,255],"outline":{"type":"esriSLS","style":"esriSLSSolid","color":[255,255,0,255],"width":10}}}}}]'
            };

            var source = new ol.source.TileArcGISRest({
                url: dynamticLayerUrl + '/MapServer',
                params: params,
                wrapX: false
            });
            var layer = new ol.layer.Tile({
                title: "测试图层",
                source: source
            });
            map.addLayer(layer);
        },
        error: function (err) {
            console.error(err);
        }
    });
</script>
</body>
</html>