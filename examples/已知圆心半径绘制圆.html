<!DOCTYPE html>
<html>
<head>
    <title>已知圆心半径绘制圆</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../lib/ol.css" type="text/css">
    <!--<script src="../lib/ol.js"></script>-->
    <script src="../lib/ol-debug.js"></script>
    <script src="../lib/jquery-1.8.0.min.js"></script>
    <style>
        #vienna {
            text-decoration: none;
            color: white;
            font-size: 11pt;
            font-weight: bold;
            text-shadow: black 0.1em 0.1em 0.2em;
        }
    </style>
</head>
<body>
<div id="map" class="map"></div>
<div id="vienna" style="display: none; margin: 0px; padding: 0px; width: 31px; height: 19px; overflow: hidden;">
    <img id="myimage" src="http://webmap0.map.bdstatic.com/wolfman/static/common/images/nbsearch_366e590.png"
         style="left: 0px; top: 0px;">
    <label unselectable="on" id="nbHandleLabel"
           style="position: absolute; display: inline;
           cursor: inherit; border: none; padding: 0px;
           white-space: nowrap; font-style: normal;
           font-variant: normal; font-weight: normal;
           font-stretch: normal; font-size: 12px;
           line-height: 20px;
           font-family: arial, simsun;
            z-index: 20020; height: 20px;
             color: black; text-indent: 5px;
              text-align: center; zoom: 1;
               width: 56px; -webkit-user-select: none;
               left: 30px; top: 0px;
               background: url(http://webmap0.map.bdstatic.com/wolfman/static/common/images/nbsearch_366e590.png) -31px 0px;"></label>
</div>

<div id="marker" title="Marker"></div>
<script>
    /*绘制空心圆*/
    /*ol.geom.Polygon([[外圈的点],[内圈的点]])*/
    var projection = ol.proj.get('EPSG:4326');
    var tileUrl = "http://211.101.37.251:6080/arcgis/rest/services/SXGXPTMAPdyone/MapServer";
    // WGS84 ellipsoid
    var sphare = new ol.Sphere(6378137);
    var ismousedown = false;
    var ismousemove = false;
    var circle = null, marker, map;
    $.ajax({
        url     : tileUrl + "?f=pjson",
        dataType: "json",
        success : function (data) {
            var resolutions = [];
            var origin      = [data.tileInfo.origin.x, data.tileInfo.origin.y];
            var len         = data.tileInfo.lods.length;
            var fullExtent  = [data.fullExtent.xmin, data.fullExtent.ymin, data.fullExtent.xmax, data.fullExtent.ymax];
            for (var i = 0; i < len; i++) {
                resolutions.push(data.tileInfo.lods[i].resolution);
            }
            var tileGrid      = new ol.tilegrid.TileGrid({
                tileSize   : data.tileInfo.cols,
                origin     : origin,
                extent     : fullExtent,
                resolutions: resolutions
            });
            var urlTemplate   = tileUrl + "/tile/{z}/{y}/{x}";
            var tileArcGISXYZ = new ol.source.XYZ({
                tileGrid       : tileGrid,
                projection     : projection,
                tileUrlFunction: function (tileCoord) {
                    var url = urlTemplate.replace('{z}', (tileCoord[0]).toString())
                            .replace('{x}', tileCoord[1].toString())
                            .replace('{y}', (-tileCoord[2] - 1).toString());
                    return url;
                }
            });


            var source = new ol.source.Vector({wrapX: false});

            var style  = ol.style.Style({
                fill  : new ol.style.Fill({
                    color: 'red'
                }),
                stroke: new ol.style.Stroke({
                    color: 'blue',
                    width: 1233
                }),
                image : new ol.style.Circle({
                    radius: 117,
                    fill  : new ol.style.Fill({
                        color: 'blue'
                    })
                })
            });
            var vector = new ol.layer.Vector({
                source: source
            });

            map = new ol.Map({
                target: 'map',
                layers: [
                    new ol.layer.Tile({
                        source: tileArcGISXYZ
                    }),
                    vector
                ],
                view  : new ol.View({
                    center    : [109.15169990462329, 31.74108365827285],
                    zoom      : 8,
                    projection: projection,
                    extent    : [60.896230706385204, 0.9508582428290315, 157.40716910286136, 62.53130907371668]
                })
            });


            function addCircle(center, radius) {
                radius  = transformRadius(center, radius);
                circle  = new ol.geom.Circle(center, radius);
                var fea = new ol.Feature({
                    geometry: circle
                });

                source.addFeature(fea);
                fea.setStyle(style);

                var length = sphare.haversineDistance(circle.getCenter(), circle.getLastCoordinate());
                length     = Math.floor(length) + 1;
                $("#nbHandleLabel").html(length + "m");


                var markerPos = circle.getLastCoordinate();
                marker        = new ol.Overlay({
                    position   : markerPos,
                    positioning: 'center-center',
                    element    : document.getElementById('vienna'),
                    offset     : [0, 0]
                });
                map.addOverlay(marker);
                document.getElementById('vienna').style.setProperty("display", "block");

                editCircle();
            }

            function editCircle() {
                $(document).on('mouseup', function (event) {
                    ismousedown = false;
                    $(document).off("mousemove");
                    $("#vienna").off('mousemove');
                });


                $("#vienna").on("mouseup", function (event) {
                    ismousedown = false;
                    $("#vienna").off('mousemove');
                });

                $("#vienna").on("mousedown", function (event) {
                    ismousedown = true;
                    event.preventDefault();
                    map.on('pointermove', function (mapmoveevt) {
                        if (ismousedown) {
                            if (mapmoveevt.preventDefault) {
                                mapmoveevt.preventDefault();
                            } else {
                                mapmoveevt.returnValue = false;
                            }
                            var length = sphare.haversineDistance(circle.getCenter(), circle.getLastCoordinate());
                            if (length - 5000 > 0) {
                                return;
                            }
                            var radius = Math.sqrt(getRadiusSquared_(mapmoveevt));
                            circle.setRadius(radius);
                            length = Math.floor(length) + 1;

                            $("#nbHandleLabel").html(length + "m");
                            marker.setPosition(circle.getLastCoordinate());
                        }
                    });
                });
            }

            function getRadiusSquared_(mapmoveevt) {
                var center        = circle.getCenter();
                var lastcoordinat = mapmoveevt.coordinate;
                var radius        = Math.pow(lastcoordinat[0] - center[0], 2) + Math.pow(lastcoordinat[1] - center[1], 2);
                if (radius - 0.0027894347136572695 > 0.0) {
                    radius = 0.0027894347136572695;
                }
                return radius;
            }

            function transformRadius(center, meterRadius) {
                var lastcoord = sphare.offset(center, meterRadius, (270 / 360) * 2 * Math.PI);
                var dx        = center[0] - lastcoord[0];
                var dy        = center[1] - lastcoord[1];
                return Math.sqrt(Math.pow(dx, 2) + Math.pow(dy, 2));
            }

            addCircle([109.15169990462329, 31.74108365827285], 500);
        },
        error   : function (err) {
            console.error(err);
        }
    });
</script>
</body>
</html>